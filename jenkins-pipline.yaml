pipeline { 
    agent any 
    environment {
        TEST="test"
        
   }
    options {
        skipStagesAfterUnstable()
    }
    stages {
        stage('Prepare enviroment') { 
            steps { 
                script {
                    try {
                        sh """
                            python3 -m venv ${WORKSPACE}/.venv_${BUILD_NUMBER}
                            echo ${WORKSPACE}/.venv_${BUILD_NUMBER}
                            . ${WORKSPACE}/.venv_${BUILD_NUMBER}/bin/activate
                            python3 -m pip install --upgrade pip
                            pip install --quiet -r ${WORKSPACE}/dev/django-k8s/web/requirements.txt
                        """
                        } catch (err) {
                            echo "Create virtual environment failed: ${err.getMessage()}"
                            error('Failed to prepare virtual environment, please check logs')
                        }
                    }
            }
        }
        stage('Test') { 
            steps { 
                script {
                try {
                sh """
                . ${WORKSPACE}/.venv_${BUILD_NUMBER}/bin/activate
                python3 ${WORKSPACE}/dev/django-k8s/web/python manage.py test
                """
                }catch (err) {
                            echo "Create virtual environment failed: ${err.getMessage()}"
                            error('Failed to prepare virtual environment, please check logs')
                        }
                }
            }
        }
        stage('Build?'){
            steps {
                
                echo 'make check'
                echo 'reports/**/*.xml' 
            }
        }
        stage('Deploy') {
            steps {
                input 'Does the staging environment look OK?'
                milestone(1)
                echo 'make publish'
            }
        }
    }
}
