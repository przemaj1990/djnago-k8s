pipeline { 
    agent any 
    environment {
        TEST="test"
        
   }
    options {
        skipStagesAfterUnstable()
    }
    stages {
        stage('Prepare enviroment') { 
            steps { 
                script {
                    try {
                        sh """
                            echo ${TEST}
                            python3 -m venv ${WORKSPACE}/.venv_${BUILD_NUMBER}
                            echo ${TEST}2
                            echo ${WORKSPACE}/.venv_${BUILD_NUMBER}
                            source ${WORKSPACE}/.venv_${BUILD_NUMBER}/bin/activate
                            echo ${TEST}3
                            python3 -m pip install --upgrade pip
                            echo ${TEST}4
                            pip install --quiet -r ${WORKSPACE}/dev/django-k8s/web/requirements.txt
                        """
                        } catch (err) {
                            echo "Create virtual environment failed: ${err.getMessage()}"
                            error('Failed to prepare virtual environment, please check logs')
                        }
                    }
            }
        }
        stage('Build') { 
            steps { 
                echo 'make' 
            }
        }
        stage('Test'){
            steps {
                echo 'make check'
                echo 'reports/**/*.xml' 
            }
        }
        stage('Deploy') {
            steps {
                input 'Does the staging environment look OK?'
                milestone(1)
                echo 'make publish'
            }
        }
    }
}
